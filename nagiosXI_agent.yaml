---
  - name: install ncpa agent on instances
    hosts: all 
    become: yes
    become_user: root  #
    tasks:
      - name: create Repo on CentOS6 
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "6"
        shell: rpm -Uvh https://assets.nagios.com/downloads/ncpa/ncpa-latest.el6.i386.rpm

      - name: Install ncpa on centos6
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "6"
        package:
          name: ncpa
          state: present
        notify: NCPA_CENTOS_6

      - name: Change the code inside ncpa.cfg
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "6"
        lineinfile:
          path: "/usr/local/ncpa/etc/ncpa.cfg"
          regexp: "community_string = mytoken" 
          line: "community_string = redhat"

      - name: create Repo on Amazon
        when: ansible_distribution == "Amazon"
        shell: rpm -Uvh https://assets.nagios.com/downloads/ncpa/ncpa-latest.el6.i386.rpm

      - name: Install ncpa on Amazon 
        when: ansible_distribution == "Amazon"
        package:
          name: ncpa
          state: present
        notify: NCPA_CENTOS_6

      - name: Change the code inside ncpa.cfg
        when: ansible_distribution == "Amazon"
        lineinfile:
          path: "/usr/local/ncpa/etc/ncpa.cfg"
          regexp: "community_string = mytoken" 
          line: "community_string = redhat"

      - name: create Repo on Centos7
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"
        shell: rpm -Uvh https://assets.nagios.com/downloads/ncpa/ncpa-latest.el7.x86_64.rpm

      - name: install ncpa on centos7
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"
        package:
          name: ncpa
          state: present 
        notify: NCPA_CENTOS_7
      
      - name: Change the code inside ncpa.cfg
        when: ansible_distribution == "CentOS" and ansible_distribution_major_version == "7"
        lineinfile:
          path: "/usr/local/ncpa/etc/ncpa.cfg"
          regexp: "community_string = mytoken" 
          line: "community_string = redhat"

  - handlers:
      - name: NCPA_CENTOS_6
        service:
          name: ncpa_listener 
          state: restarted 

      - name: NCPA_CENTOS_7
        systemd:
          name: ncpa_listener 
          state: restarted 

